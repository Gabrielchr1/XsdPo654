{% extends "admin/base_admin.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mt-4">{{ title }}</h2> <p class="lead text-muted">Para o cliente: <strong>{{ client.name }}</strong></p>
    </div>
</div>

{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="card shadow-sm">
    <div class="card-body p-4">
        <form method="POST" action="" novalidate>
            {{ form.hidden_tag() }}
            
            <h4 class="text-muted fw-light mb-3">Dados Gerais da Proposta</h4>
            <div class="row">
                <div class="col-md-8 mb-3">
                    {{ form.title.label(class="form-label") }}
                    {{ form.title(class="form-control", placeholder="Ex: Proposta Residencial Família Silva") }}
                    {% for error in form.title.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.valid_until.label(class="form-label") }}
                    {{ form.valid_until(class="form-control", type="date") }}
                    {% for error in form.valid_until.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Taxas e Tarifas da Concessionária</h4>
            <div class="row">
                <div class="col-md-5 mb-3">
                    <label class="form-label">Concessionária</label>
                    <div class="input-group">
                        {{ form.concessionaria(class="form-select", id="concessionaria_select") }}
                        <button type="button" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#addConcessionariaModal" title="Adicionar nova concessionária"><i class="fas fa-plus"></i></button>
                    </div>
                    {% for error in form.concessionaria.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-3 mb-3">
                    {{ form.kwh_price.label(class="form-label") }}
                    {{ form.kwh_price(class="form-control", placeholder="Ex: 0.95") }}
                    {% for error in form.kwh_price.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.public_lighting_fee.label(class="form-label") }}
                     <div class="input-group">
                        <span class="input-group-text">R$</span>
                        {{ form.public_lighting_fee(class="form-control", placeholder="Ex: 25.50") }}
                    </div>
                    {% for error in form.public_lighting_fee.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>

            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Dados de Consumo e Rede Elétrica</h4>
            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <label class="form-label">Forma de Análise</label>
                    <div class="d-flex pt-2">
                        {% for subfield in form.consumption_input_type %}<div class="form-check me-3">{{ subfield(class="form-check-input") }} {{ subfield.label(class="form-check-label") }}</div>{% endfor %}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div id="kwh-input-group">{{ form.avg_consumption_kwh.label(class="form-label") }}{{ form.avg_consumption_kwh(class="form-control") }}{% for error in form.avg_consumption_kwh.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}</div>
                    <div id="brl-input-group" class="d-none">
                        {{ form.avg_bill_brl.label(class="form-label") }}
                        <div class="input-group"><span class="input-group-text">R$</span>{{ form.avg_bill_brl(class="form-control") }}</div>
                        {% for error in form.avg_bill_brl.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.grid_type.label(class="form-label") }}
                    {{ form.grid_type(class="form-select") }}
                    {% for error in form.grid_type.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>
            
            <hr class="form-section-divider">
            <h4 class="text-muted fw-light mb-3">Detalhes Técnicos e Financeiros</h4>
            <div class="row">
                <div class="col-md-4 mb-3">
                    {{ form.system_power_kwp.label(class="form-label") }}
                    <div class="input-group">
                        {{ form.system_power_kwp(class="form-control", placeholder="Ex: 8.12") }}
                        <span class="input-group-text">kWp</span>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    {{ form.total_investment.label(class="form-label") }}
                    <div class="input-group">
                        <span class="input-group-text">R$</span>
                        {{ form.total_investment(class="form-control", placeholder="25000.00") }}
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <label class="form-label">Irradiação Solar (Hsp)</label>
                    <div class="input-group">
                        {{ form.solar_irradiance(class="form-control", id="solar_irradiance") }}
                        <button class="btn btn-outline-secondary" type="button" id="fetchIrradianceBtn" data-client-id="{{ client.id }}">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span><i class="fas fa-search-location"></i> Buscar
                        </button>
                    </div>
                    {% for error in form.solar_irradiance.errors %}<div class="text-danger small mt-1">{{ error }}</div>{% endfor %}
                </div>
            </div>
            <div class="mb-3">
                {{ form.notes.label(class="form-label") }}
                {{ form.notes(class="form-control", rows=3) }}
            </div>

            <hr class="form-section-divider">
            <div class="d-flex justify-content-end gap-2">
                <a href="{{ url_for('main.clients') }}" class="btn btn-light">Cancelar</a>
                {{ form.submit(class="btn btn-success") }}
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="addConcessionariaModal" tabindex="-1" aria-labelledby="addConcessionariaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="addConcessionariaForm" action="{{ url_for('main.add_concessionaria') }}" method="POST" novalidate>
                {{ concessionaria_form.hidden_tag() }}
                <div class="modal-header">
                    <h5 class="modal-title" id="addConcessionariaModalLabel">Adicionar Nova Concessionária</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        {{ concessionaria_form.name.label(class="form-label") }}
                        {{ concessionaria_form.name(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ concessionaria_form.fio_b_price.label(class="form-label") }}
                        {{ concessionaria_form.fio_b_price(class="form-control", placeholder="Ex: 0.32") }}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    {{ concessionaria_form.submit(class="btn btn-success") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}