<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Proposta - {{ proposal.title }}</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        :root {
            --primary-green: #28a745; --dark-text: #2c3e50; --light-text: #576574;
            --background-gray: #f8f9fa; --border-color: #e2e8f0;
        }
        @page { size: A4; margin: 2.5cm 2cm;
            @bottom-center { content: "Página " counter(page) " de " counter(pages); font-size: 10px; color: var(--light-text); }
        }
        @page:first { margin: 0; @bottom-center { content: ""; } }
        
        body { font-family: 'Inter', sans-serif; color: var(--dark-text); font-size: 11px; line-height: 1.5; }
        h1, h2, h3, h4 { font-weight: 700; color: var(--primary-green); margin: 0; }
        /* AJUSTE DE ESPAÇAMENTO: Margens dos títulos reduzidas */
        h2 { font-size: 18px; border-bottom: 2px solid var(--primary-green); padding-bottom: 5px; margin-top: 20px; margin-bottom: 15px; break-after: avoid-page; }
        h3 { font-size: 16px; color: var(--dark-text); margin-top: 15px; margin-bottom: 10px; }
        p { margin: 0 0 8px 0; }
        .page-break { page-break-after: always; }
        
        .cover-page {
            width: 210mm; height: 297mm; background-image: url('https://images.pexels.com/photos/9893727/pexels-photo-9893727.jpeg');
            background-size: cover; background-position: center; position: relative; color: white;
            display: flex; flex-direction: column; justify-content: flex-end; text-align: left;
        }
        .cover-page::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to top, rgba(0, 0, 0, 0.8), transparent); }
        .cover-content { position: relative; z-index: 1; padding: 2.5cm; }
        .cover-content h1 { font-size: 36px; color: white; border: none; line-height: 1.2; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .cover-content p { font-size: 18px; }

        .header { position: running(header); text-align: right; font-size: 10px; color: var(--light-text); }
        @page { @top-right { content: element(header); padding-top: 1cm; } }
        
        .intro-page .lead { font-size: 13px; line-height: 1.7; color: var(--light-text); margin-top: 1cm; }

        .kpi-cards-container { display: flex; justify-content: space-between; gap: 10px; margin-top: 15px; }
        .kpi-card { flex: 1; padding: 10px; border-radius: 8px; background-color: var(--background-gray); border: 1px solid var(--border-color); text-align: center; }
        .kpi-card .icon { font-size: 22px; color: var(--primary-green); margin-bottom: 5px; }
        .kpi-card .label { font-size: 9px; font-weight: 600; text-transform: uppercase; margin-bottom: 3px; }
        .kpi-card .value { font-size: 16px; font-weight: 700; color: var(--dark-text); }
        
        .financial-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .financial-table td { padding: 10px; border-bottom: 1px solid var(--border-color); }
        .financial-table tr:last-child td { border-bottom: none; }
        .financial-table td:first-child { font-weight: 600; color: var(--light-text); }
        .financial-table td:last-child { text-align: right; font-weight: 700; font-size: 13px; }
        .financial-table .total-investment { color: #dc3545; }
        .financial-table .total-savings { color: var(--primary-green); }

        .service-cards-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .service-card { display: flex; align-items: center; gap: 10px; flex: 1 1 48%; background-color: var(--background-gray); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        .service-card i { font-size: 20px; color: var(--primary-green); }
        .service-card h4 { font-size: 11px; font-weight: 600; color: var(--dark-text); }
        
        /* NOVO ESTILO PARA A GRADE DE LOGOS 10x2 */
        .client-logos-section { text-align: center; break-inside: avoid; }
        .client-logos-container {
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            gap: 15px 25px; /* Espaçamento vertical e horizontal */
            padding: 15px 0; margin-top: 20px;
            border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color);
        }
        .logo-box { flex-basis: 8%; font-size: 28px; color: #a0aec0; }
        
        .signatures-section { display: flex; justify-content: space-around; text-align: center; margin-top: 40px; page-break-before: always; }
        .signature-box { width: 45%; padding-top: 20px; }
        .signature-line { border-bottom: 1px solid var(--dark-text); margin-bottom: 10px; padding-bottom: 30px; }
        .signature-box strong { font-size: 12px; font-weight: 700; }
        .signature-box p { font-size: 10px; color: var(--light-text); margin: 2px 0; }
        
        .items-table { width: 100%; margin-top: 15px; border-collapse: collapse; break-inside: avoid; }
        .items-table th, .items-table td { padding: 8px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .items-table thead { background-color: var(--background-gray); font-weight: 600; }
        .items-table tbody tr:nth-child(even) { background-color: var(--background-gray); }
        .items-table .text-center { text-align: center; }
        .items-table .text-right { text-align: right; }
        
        .triggers-section { display: flex; gap: 15px; margin-top: 15px; }
        .trigger-box { flex: 1; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .trigger-box h4 { font-size: 12px; margin-bottom: 5px; color: var(--dark-text); }
        .trigger-box p { font-size: 10px; }
        
        .chart-container { margin-top: 20px; text-align: center; break-inside: avoid; }
        .chart-container h3 { font-size: 14px; color: var(--light-text); margin-bottom: 10px; }
        .chart-container img { max-width: 100%; }
    </style>
</head>
<body>
    <div class="cover-page">
        <div class="cover-content">
            <h1>{{ proposal.title }}</h1>
            <p>{{ proposal.client.name }}</p>
            <p style="font-size: 12px; margin-top: 20px;">Gerado por: {{ proposal.author.username }} | Data: {{ proposal.creation_date.strftime('%d/%m/%Y') }}</p>
        </div>
    </div>

    <div class="page-break"></div>

    <div class="header"><strong>SoluçãoSolar</strong> | Proposta para {{ proposal.client.name }}</div>

    <div class="content-page">
        <div class="intro-page">
            <h2>Uma Nova Era de Energia para Você</h2>
            <p class="lead">Prezado(a) {{ proposal.client.name.split(' ')[0] }},</p>
            <p>Agradecemos a oportunidade de apresentar sua proposta personalizada para um sistema de energia solar fotovoltaica. A seguir, detalhamos a solução técnica que projetamos para você e, mais importante, demonstramos como este investimento se traduz em economia, segurança e sustentabilidade para os próximos anos.</p>
        </div>

        <h2>Análise Técnica e de Viabilidade Financeira</h2>
        <div class="kpi-cards-container">
            <div class="kpi-card"><div class="icon"><i class="fas fa-solar-panel"></i></div><div class="label">Potência</div><div class="value">{{ "%.2f"|format(proposal.system_power_kwp or 0) }} kWp</div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-bolt"></i></div><div class="label">Produção Média Mensal</div><div class="value">{{ "{:,.0f}".format(proposal.monthly_production_kwh|sum / 12) if proposal.monthly_production_kwh else 0 }} kWh</div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-piggy-bank"></i></div><div class="label">Economia Anual</div><div class="value">R$ {{ "{:,.2f}".format(proposal.estimated_savings_per_year or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</div></div>
            <div class="kpi-card"><div class="icon"><i class="fas fa-undo-alt"></i></div><div class="label">Payback</div><div class="value">{{ "%.1f"|format(proposal.payback_years or 0) }} Anos</div></div>
        </div>

        {% if monthly_chart_b64 %}
        <div class="chart-container">
            <h3>Produção Mensal Estimada (kWh)</h3>
            <img src="data:image/png;base64,{{ monthly_chart_b64 }}">
        </div>
        {% endif %}

        <h3>Resumo Financeiro</h3>
        <table class="financial-table">
            <tbody>
                <tr><td>Valor do Investimento Total</td><td class="total-investment">R$ {{ "{:,.2f}".format(proposal.total_investment or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td></tr>
                <tr><td>Economia Estimada no 1º Ano</td><td class="total-savings">R$ {{ "{:,.2f}".format(proposal.estimated_savings_per_year or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td></tr>
                <tr>
                    {% set savings_25_years = (proposal.estimated_savings_per_year or 0) * 25 %}
                    <td>Economia Acumulada em 25 Anos</td><td class="total-savings">R$ {{ "{:,.2f}".format(savings_25_years) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td>
                </tr>
            </tbody>
        </table>

        {% if payback_chart_b64 %}
        <div class="chart-container">
            <h3>Projeção de Retorno do Investimento</h3>
            <img src="data:image/png;base64,{{ payback_chart_b64 }}">
        </div>
        {% endif %}

        <h2>Vantagens do Seu Investimento</h2>
        <div class="triggers-section">
            <div class="trigger-box"><h4><i class="fas fa-shield-alt"></i> Proteção Financeira</h4><p>Gere sua própria energia e se proteja contra os aumentos anuais da tarifa de energia.</p></div>
            <div class="trigger-box"><h4><i class="fas fa-arrow-alt-circle-up"></i> Valorização do Imóvel</h4><p>Imóveis com sistema solar são mais valorizados no mercado, um benefício duplo.</p></div>
            <div class="trigger-box"><h4><i class="fas fa-leaf"></i> Sustentabilidade</h4><p>Deixe de emitir toneladas de CO₂ e contribua para um planeta mais limpo.</p></div>
        </div>

        <h2>Detalhes do Kit Fotovoltaico</h2>
        <table class="items-table">
            <thead><tr><th class="text-center">Qtd.</th><th>Descrição</th><th class="text-right">Total</th></tr></thead>
            <tbody>
                {% for item in proposal.items %}
                <tr><td class="text-center">{{ item.quantity }}</td><td>{{ item.description }}</td><td class="text-right">R$ {{ "{:,.2f}".format(item.total_price or 0) | replace(',', 'X') | replace('.', ',') | replace('X', '.') }}</td></tr>
                {% else %}
                <tr><td colspan="3" class="text-center p-3">Nenhum item detalhado.</td></tr>
                {% endfor %}
            </tbody>
        </table>
        
        <h2>Nossa Solução Completa</h2>
        <div class="service-cards-container">
            <div class="service-card"><i class="fas fa-solar-panel"></i><h4>Projeto e Homologação</h4></div>
            <div class="service-card"><i class="fas fa-tools"></i><h4>Instalação Especializada</h4></div>
            <div class="service-card"><i class="fas fa-headset"></i><h4>Suporte Pós-Venda</h4></div>
            <div class="service-card"><i class="fas fa-chart-line"></i><h4>Monitoramento de Performance</h4></div>
        </div>

        <div class="client-logos-section">
            <h2>Nossos Clientes Confiam</h2>
            <div class="client-logos-container">
                <div class="logo-box"><i class="fas fa-store"></i></div> <div class="logo-box"><i class="fas fa-tractor"></i></div>
                <div class="logo-box"><i class="fas fa-hospital"></i></div> <div class="logo-box"><i class="fas fa-home"></i></div>
                <div class="logo-box"><i class="fas fa-school"></i></div> <div class="logo-box"><i class="fas fa-industry"></i></div>
                <div class="logo-box"><i class="fas fa-hotel"></i></div> <div class="logo-box"><i class="fas fa-church"></i></div>
                <div class="logo-box"><i class="fas fa-warehouse"></i></div> <div class="logo-box"><i class="fas fa-gas-pump"></i></div>
                
                <div class="logo-box"><i class="fas fa-store-alt"></i></div> <div class="logo-box"><i class="fas fa-seedling"></i></div>
                <div class="logo-box"><i class="fas fa-clinic-medical"></i></div> <div class="logo-box"><i class="fas fa-building"></i></div>
                <div class="logo-box"><i class="fas fa-university"></i></div> <div class="logo-box"><i class="fas fa-cogs"></i></div>
                <div class="logo-box"><i class="fas fa-synagogue"></i></div> <div class="logo-box"><i class="fas fa-mosque"></i></div>
                <div class="logo-box"><i class="fas fa-hard-hat"></i></div> <div class="logo-box"><i class="fas fa-car"></i></div>
            </div>
        </div>

        <div class="signatures-section">
            <div class="signature-box"><div class="signature-line"></div><strong>{{ proposal.author.username }}</strong><p>Consultor de Vendas | SoluçãoSolar</p><p>{{ proposal.author.email }}</p></div>
            <div class="signature-box"><div class="signature-line"></div><strong>Eng. Responsável Fictício</strong><p>Engenheiro Eletricista</p><p>CREA: 123456789-0</p></div>
        </div>
    </div>
</body>
</html>